# PWA Testing Guide for Half Trip

This guide explains how to test the Progressive Web App (PWA) features of Half Trip.

## Prerequisites

- Node.js and pnpm installed
- Supabase project configured with environment variables
- Modern browser (Chrome, Edge, Safari, or Firefox)

## PWA Features Implemented

### 1. **Web App Manifest**

- Configured in `src/app/manifest.ts`
- Includes app name, description, icons, colors, and display mode
- Defines how the app appears when installed

### 2. **Service Worker**

- Automatically generated by `@ducanh2912/next-pwa`
- Caches assets for offline use
- Handles background sync and push notifications (future)

### 3. **App Icons**

- Generated in multiple sizes (72x72 to 512x512)
- Source SVG: `public/icon.svg`
- Generated PNGs: `public/icons/icon-*.png`
- Apple touch icon: `public/apple-touch-icon.png`
- Favicon: `public/favicon.ico`

### 4. **Install Prompt**

- Component: `src/components/pwa/install-prompt.tsx`
- Shows install banner for eligible users
- Respects user dismissal (7-day cooldown)
- Only shows on non-installed browsers

### 5. **Offline Fallback Page**

- Route: `/offline`
- Component: `src/app/offline/page.tsx`
- Shows helpful message when offline
- Suggests cached content available

## Testing the PWA

### Step 1: Build for Production

The service worker is **disabled in development mode** to avoid caching issues during development.

```bash
pnpm build
pnpm start
```

The app will run on `http://localhost:3000` (or the configured port).

### Step 2: Test with Lighthouse

1. Open Chrome DevTools (F12)
2. Go to the "Lighthouse" tab
3. Select "Progressive Web App" category
4. Click "Analyze page load"
5. Review PWA score and recommendations

### Step 3: Test Installation

#### On Desktop (Chrome/Edge):

1. Visit the app in production mode
2. Look for an install icon in the address bar
3. Click it or use the install prompt banner
4. App will install as a standalone application
5. Check your OS applications/Start menu for "Half Trip"

#### On Mobile (iOS Safari):

1. Visit the app in Safari
2. Tap the Share button
3. Scroll down and tap "Add to Home Screen"
4. Tap "Add" to install
5. App icon will appear on your home screen

#### On Mobile (Android Chrome):

1. Visit the app in Chrome
2. Look for the install banner at the bottom
3. Tap "Install" or use the three-dot menu > "Install app"
4. App will install to your home screen

### Step 4: Test Offline Functionality

1. Install the app using steps above
2. Open the installed app
3. Navigate to a trip you've already loaded
4. Open DevTools > Network tab
5. Check "Offline" to simulate offline mode
6. The app should continue working with cached data
7. Try creating/editing content - it will sync when online

### Step 5: Test Service Worker

1. Open DevTools > Application tab
2. Click "Service Workers" in the sidebar
3. Verify the service worker is registered and running
4. Check "Cache Storage" to see cached assets
5. Test "Update on reload" to force SW updates

## Development Workflow

### Regenerate Icons

If you modify `public/icon.svg`:

```bash
pnpm generate-icons
```

This will regenerate all icon sizes.

### Disable PWA in Development

PWA is automatically disabled when `NODE_ENV=development`. The service worker will not be generated or registered during `pnpm dev`.

### Test PWA in Development

If you need to test PWA features during development:

1. Edit `next.config.ts` and set `disable: false`
2. Run `pnpm build && pnpm start`
3. Remember to set it back to `disable: process.env.NODE_ENV === 'development'` after testing

## Configuration Files

- **Next.js Config**: `next.config.ts`
- **Manifest**: `src/app/manifest.ts`
- **Root Layout**: `src/app/layout.tsx` (PWA metadata)
- **Install Prompt**: `src/components/pwa/install-prompt.tsx`
- **Offline Page**: `src/app/offline/page.tsx`
- **Icon Generator**: `scripts/generate-icons.js`

## PWA Checklist

### Installation:

- [ ] App can be installed on desktop
- [ ] App can be installed on mobile
- [ ] Install prompt appears correctly
- [ ] App icon displays properly after installation
- [ ] App opens in standalone mode (no browser chrome)

### Offline:

- [ ] App loads when offline (cached pages)
- [ ] Previously viewed trips accessible offline
- [ ] Offline indicator shows when disconnected
- [ ] Service worker caches assets correctly

### Performance:

- [ ] Lighthouse PWA score > 90
- [ ] Fast page loads with service worker cache
- [ ] Icons load without delay

### UX:

- [ ] Install prompt dismissal works (doesn't show again for 7 days)
- [ ] Theme color matches brand
- [ ] App name displays correctly in app switcher
- [ ] Splash screen shows on iOS (uses apple-touch-icon)

## Troubleshooting

### Service Worker Not Registering

- Ensure you're running in production mode (`pnpm build && pnpm start`)
- Check browser console for registration errors
- Clear browser cache and hard reload (Ctrl+Shift+R)

### Install Prompt Not Showing

- App must be served over HTTPS (or localhost)
- User must not have dismissed prompt recently (7-day cooldown)
- App must meet PWA installability criteria
- Check if app is already installed

### Offline Mode Not Working

- Ensure service worker is registered and active
- Check DevTools > Application > Cache Storage for cached assets
- Visit pages while online first to cache them
- Check console for service worker errors

### Icons Not Displaying

- Run `pnpm generate-icons` to regenerate icons
- Check `public/icons/` directory for PNG files
- Verify manifest points to correct icon paths
- Clear browser cache

## Production Deployment

When deploying to production (Vercel, Netlify, etc.):

1. Ensure `NODE_ENV=production` is set
2. Service worker will be generated during build
3. App will be installable if served over HTTPS
4. Test installation on production domain

## Future PWA Enhancements

- **Push Notifications**: Notify users of trip updates
- **Background Sync**: Sync expense changes in background
- **Share Target**: Allow sharing locations/photos to app
- **App Shortcuts**: Quick actions from app icon (add expense, view trips)

## Resources

- [Next.js PWA Documentation](https://ducanh-next-pwa.vercel.app/)
- [Web.dev PWA Guide](https://web.dev/progressive-web-apps/)
- [MDN PWA Documentation](https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps)
